<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learn Chinese Radicals</title>
    <meta name="description" content="Learn Chinese characters through their radicals - the building blocks of written Chinese">
    <style>
        :root {
            --bg-dark: #0f0f11;
            --bg-card: #1a1a1f;
            --bg-hover: #252530;
            --accent: #ff6b6b;
            --accent-secondary: #4ecdc4;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a8;
            --text-muted: #6a6a72;
            --border: #2a2a35;
            --shadow: rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans SC', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--bg-card) 0%, #1f1f28 100%);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .header-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .header-tabs .tab {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .header-tabs .tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .header-tabs .tab.active {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .nav-breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
        }

        .nav-breadcrumb a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.2s;
        }

        .nav-breadcrumb a:hover {
            color: var(--accent);
        }

        .nav-breadcrumb .separator {
            color: var(--text-muted);
        }

        .nav-breadcrumb .current {
            color: var(--text-primary);
        }

        /* Main Layout */
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* View Toggle */
        .view-header {
            margin-bottom: 2rem;
        }

        .view-header h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .view-header p {
            color: var(--text-secondary);
        }

        .stats {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
        }

        .stat {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Radical Grid */
        .radical-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }

        .radical-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
        }

        .radical-card:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .radical-char {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .radical-pinyin {
            color: var(--accent-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .radical-meaning {
            color: var(--text-secondary);
            font-size: 0.8rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .radical-count {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        /* Radical Detail View */
        .radical-detail {
            display: none;
        }

        .radical-detail.active {
            display: block;
        }

        .radical-hero {
            background: linear-gradient(135deg, var(--bg-card) 0%, #1f1f28 100%);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .radical-hero .char {
            font-size: 6rem;
            font-weight: 300;
            line-height: 1;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .radical-hero .pinyin {
            font-size: 1.5rem;
            color: var(--accent-secondary);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .radical-hero .meaning {
            font-size: 1.25rem;
            color: var(--text-secondary);
        }

        .radical-hero .meta {
            margin-top: 1.5rem;
            color: var(--text-muted);
        }

        /* Character List */
        .character-section h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .character-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: inherit;
        }

        .character-card:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        .character-card .char {
            font-size: 2.5rem;
            min-width: 60px;
            text-align: center;
        }

        .character-card .info {
            flex: 1;
            min-width: 0;
        }

        .character-card .pinyin {
            color: var(--accent-secondary);
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .character-card .definition {
            color: var(--text-secondary);
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .grade-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            padding: 0 6px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .grade-badge.grade-1 { background: #22c55e; color: white; }
        .grade-badge.grade-2 { background: #84cc16; color: white; }
        .grade-badge.grade-3 { background: #eab308; color: #1a1a1f; }
        .grade-badge.grade-4 { background: #f97316; color: white; }
        .grade-badge.grade-5 { background: #ef4444; color: white; }
        .grade-badge.grade-6 { background: #a855f7; color: white; }
        .grade-badge.grade-0 { background: var(--border); color: var(--text-muted); }

        .character-card .meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .character-card .strokes {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        /* Character Detail View */
        .character-detail {
            display: none;
        }

        .character-detail.active {
            display: block;
        }

        .character-hero {
            background: linear-gradient(135deg, var(--bg-card) 0%, #1f1f28 100%);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 3rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .character-hero .char {
            font-size: 8rem;
            font-weight: 300;
            line-height: 1;
            margin-bottom: 1.5rem;
        }

        .character-hero .pinyin {
            font-size: 2rem;
            color: var(--accent-secondary);
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .character-hero .definition {
            font-size: 1.25rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        .radical-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            padding: 0.75rem 1.25rem;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
        }

        .radical-link:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .radical-link .radical-char {
            font-size: 1.5rem;
            margin-bottom: 0;
        }

        /* Decomposition Section */
        .decomposition-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .decomposition-box h3 {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }

        .ids-visual {
            text-align: center;
            padding: 1rem;
            background: var(--bg-hover);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .ids-level {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .ids-level[data-level="0"] {
            font-size: 2rem;
        }
        
        .ids-level[data-level="1"] {
            font-size: 1.75rem;
            padding: 0.25rem 0.5rem;
            background: rgba(78, 205, 196, 0.1);
            border-radius: 6px;
            border: 1px dashed var(--border);
        }
        
        .ids-level[data-level="2"] {
            font-size: 1.5rem;
            padding: 0.2rem 0.4rem;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 4px;
        }
        
        .ids-op {
            color: var(--text-muted);
            font-size: 0.8em;
            margin-right: 0.25rem;
        }
        
        .ids-children {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .ids-visual .component-tag {
            padding: 0.25rem 0.5rem;
            font-size: inherit;
        }
        
        .ids-visual .component-tag .char {
            font-size: 1em;
        }

        .components {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .component-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }

        .component-tag:hover {
            border-color: var(--accent);
            background: rgba(255, 107, 107, 0.1);
        }

        .component-tag .char {
            font-size: 1.5rem;
        }

        .variant-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            margin-top: 0.5rem;
        }

        .variant-link:hover {
            border-color: var(--accent-secondary);
            background: rgba(78, 205, 196, 0.1);
        }

        .variant-char {
            font-size: 1.5rem;
            color: var(--accent-secondary);
        }

        /* Example Words Section */
        .words-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .words-section h3 {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }

        .words-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.75rem;
        }

        .word-tag {
            display: flex;
            flex-direction: column;
            padding: 0.75rem 1rem;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .word-tag:hover {
            border-color: var(--accent-secondary);
        }

        .word-tag .word-header {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .word-tag .word-chars {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .word-tag .pinyin {
            color: var(--accent-secondary);
            font-size: 0.85rem;
        }

        .word-tag .definition {
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* Appears In Section */
        .appears-in-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .appears-in-section h3 {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }

        .derived-chars {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
        }

        .derived-char {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1.5rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s;
        }

        .derived-char:hover {
            border-color: var(--accent);
            transform: scale(1.1);
        }

        /* Word Detail Page */
        .word-detail {
            display: none;
            padding: 2rem 0;
        }

        .word-detail.active {
            display: block;
        }

        .word-hero {
            text-align: center;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-radius: 16px;
            margin-bottom: 2rem;
        }

        .word-chars {
            font-size: 3.5rem;
            letter-spacing: 0.2em;
            margin-bottom: 1rem;
        }

        .word-pinyin {
            font-size: 1.5rem;
            color: var(--accent-secondary);
            margin-bottom: 0.5rem;
        }

        .word-definition {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto 1rem;
            line-height: 1.6;
        }

        .frequency-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .frequency-badge.common {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--accent-secondary);
            color: var(--accent-secondary);
        }

        .character-breakdown {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .character-breakdown h3 {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }

        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .breakdown-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.2s;
        }

        .breakdown-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .breakdown-char {
            font-size: 2.5rem;
            line-height: 1;
        }

        .breakdown-info {
            flex: 1;
        }

        .breakdown-pinyin {
            color: var(--accent-secondary);
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }

        .breakdown-meaning {
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 4rem;
            color: var(--text-muted);
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 1rem;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Search */
        .search-container {
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-input:focus {
            border-color: var(--accent);
        }

        /* Sort Controls */
        .controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .sort-select {
            padding: 0.75rem 1rem;
            padding-right: 2.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23a0a0a8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
        }

        .sort-select:focus {
            border-color: var(--accent);
        }

        .filter-pills {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-pill {
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-pill:hover {
            border-color: var(--accent);
        }

        .filter-pill.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Learn Page */
        .learn-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 2rem;
        }

        .learn-count {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-left: auto;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination button:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .pagination button.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header {
                padding: 1rem;
            }

            main {
                padding: 1rem;
            }

            .radical-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
                gap: 0.75rem;
            }

            .radical-card {
                padding: 1rem;
            }

            .radical-char {
                font-size: 2rem;
            }

            .character-grid {
                grid-template-columns: 1fr;
            }

            .radical-hero .char {
                font-size: 4rem;
            }

            .character-hero .char {
                font-size: 5rem;
            }
        }
        
        /* Settings & Chat Panel Styles */
        .settings-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .settings-btn:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            max-width: 450px;
            width: 90%;
        }
        
        .modal h2 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .modal label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .modal input[type="password"],
        .modal input[type="text"] {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-hover);
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        
        .modal-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-primary:hover {
            background: #ff5252;
        }
        
        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        /* Chat Panel */
        .chat-panel {
            position: fixed;
            top: 0;
            right: -420px;
            width: 400px;
            min-width: 320px;
            max-width: 80vw;
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            z-index: 500;
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
            box-shadow: -4px 0 20px var(--shadow);
        }
        
        .chat-panel.active {
            right: 0;
        }
        
        .chat-panel.resizing {
            transition: none;
            user-select: none;
        }
        
        .chat-resize-handle {
            position: absolute;
            left: 0;
            top: 0;
            width: 6px;
            height: 100%;
            cursor: ew-resize;
            background: transparent;
            z-index: 10;
        }
        
        .chat-resize-handle:hover,
        .chat-resize-handle.active {
            background: var(--accent);
        }
        
        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-hover);
        }
        
        .chat-header h3 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.25rem;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .chat-message {
            max-width: 90%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            line-height: 1.5;
            font-size: 0.95rem;
        }
        
        .chat-message.user {
            background: var(--accent);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.assistant {
            background: var(--bg-hover);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .chat-message.assistant p {
            margin-bottom: 0.5rem;
        }
        
        .chat-message.assistant p:last-child {
            margin-bottom: 0;
        }
        
        .chat-message.assistant h2,
        .chat-message.assistant h3,
        .chat-message.assistant h4 {
            margin: 0.75rem 0 0.5rem 0;
            color: var(--accent-secondary);
        }
        
        .chat-message.assistant h2:first-child,
        .chat-message.assistant h3:first-child,
        .chat-message.assistant h4:first-child {
            margin-top: 0;
        }
        
        .chat-message.assistant h2 { font-size: 1.1rem; }
        .chat-message.assistant h3 { font-size: 1rem; }
        .chat-message.assistant h4 { font-size: 0.95rem; }
        
        .chat-message.assistant ul {
            margin: 0.5rem 0;
            padding-left: 1.25rem;
        }
        
        .chat-message.assistant li {
            margin-bottom: 0.25rem;
        }
        
        .chat-message.assistant code {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .chat-message.assistant strong {
            color: var(--accent-secondary);
        }
        
        .chat-message.assistant .chinese-link {
            color: var(--accent);
            text-decoration: none;
            border-bottom: 1px dotted var(--accent);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chat-message.assistant .chinese-link:hover {
            color: var(--accent-secondary);
            border-bottom-color: var(--accent-secondary);
        }
        
        .chat-prompts {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .quick-prompt {
            padding: 0.4rem 0.75rem;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 16px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-prompt:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-hover);
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: none;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .chat-send {
            padding: 0.75rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .chat-send:hover {
            background: #ff5252;
        }
        
        .chat-send:disabled {
            background: var(--border);
            cursor: not-allowed;
        }
        
        .ask-ai-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .ask-ai-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 0.5rem;
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }
        
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">Êº¢Â≠ó Radicals</div>
            <nav class="header-tabs">
                <a href="#" class="tab active" id="tab-radicals" onclick="showRadicalList(); return false;">By Radical</a>
                <a href="#learn" class="tab" id="tab-learn" onclick="showLearnPage(); return false;">By Level</a>
                <a href="#phonetic" class="tab" id="tab-phonetic" onclick="showPhoneticPage(); return false;">By Component</a>
            </nav>
            <nav class="nav-breadcrumb" id="breadcrumb">
                <a href="#" onclick="showRadicalList(); return false;">All Radicals</a>
            </nav>
            <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
        </div>
    </header>

    <main>
        <!-- Radical List View -->
        <section id="radical-list" class="view">
            <div class="view-header">
                <h1>Chinese Radicals</h1>
                <p>Click any radical to explore its derivative characters</p>
                <div class="stats">
                    <div class="stat">
                        <span class="stat-number" id="radical-count">214</span>
                        <span class="stat-label">Radicals</span>
                    </div>
                    <div class="stat">
                        <span class="stat-number" id="char-count">-</span>
                        <span class="stat-label">Characters</span>
                    </div>
                </div>
            </div>
            <div class="search-container">
                <input type="text" class="search-input" id="radical-search" 
                       placeholder="Search by meaning or pinyin...">
            </div>
            <div class="radical-grid" id="radical-grid">
                <div class="loading">Loading radicals</div>
            </div>
        </section>

        <!-- Learn Page View -->
        <section id="learn-page" class="view" style="display: none;">
            <div class="view-header">
                <h1>Learn Characters</h1>
                <p>Progress from beginner to advanced, sorted by frequency</p>
            </div>
            <div class="learn-controls">
                <select class="sort-select" id="learn-grade-filter" onchange="renderLearnGrid()">
                    <option value="all">All Grades</option>
                    <option value="1">Grade 1 (Beginner)</option>
                    <option value="2">Grade 2</option>
                    <option value="3">Grade 3</option>
                    <option value="4">Grade 4</option>
                    <option value="5">Grade 5</option>
                    <option value="6">Grade 6 (Advanced)</option>
                    <option value="0">Ungraded</option>
                </select>
                <select class="sort-select" id="learn-sort" onchange="renderLearnGrid()">
                    <option value="frequency">Sort: Most Common First</option>
                    <option value="strokes">Sort: Fewest Strokes First</option>
                    <option value="grade">Sort: By Grade Level</option>
                </select>
                <select class="sort-select" id="learn-script" onchange="renderLearnGrid()">
                    <option value="simplified">Simplified (ÁÆÄ‰Ωì)</option>
                    <option value="traditional">Traditional (ÁπÅÈ´î)</option>
                </select>
                <span class="learn-count" id="learn-count"></span>
            </div>
            <div class="character-grid" id="learn-grid"></div>
            <div class="pagination" id="learn-pagination"></div>
        </section>

        <!-- Phonetic Component List View -->
        <section id="phonetic-page" class="view" style="display: none;">
            <div class="view-header">
                <h1>Common Components</h1>
                <p>Characters sorted by how often they appear as building blocks in other characters</p>
            </div>
            <div class="learn-controls">
                <select class="grade-select" id="phonetic-min-derived" onchange="renderPhoneticGrid()">
                    <option value="5">Min 5 derived chars</option>
                    <option value="10" selected>Min 10 derived chars</option>
                    <option value="20">Min 20 derived chars</option>
                    <option value="50">Min 50 derived chars</option>
                </select>
                <select class="sort-select" id="phonetic-sort" onchange="renderPhoneticGrid()">
                    <option value="count">Sort: Most Derivatives</option>
                    <option value="frequency">Sort: Most Common</option>
                </select>
                <span class="learn-count" id="phonetic-count"></span>
            </div>
            <div class="character-grid" id="phonetic-grid"></div>
            <div class="pagination" id="phonetic-pagination"></div>
        </section>

        <!-- Phonetic Detail View -->
        <section id="phonetic-detail" class="radical-detail view">
            <div class="radical-hero" id="phonetic-hero">
                <!-- Populated by JS -->
            </div>
            <div class="character-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2>Derived Characters (<span id="phonetic-derived-count">0</span>)</h2>
                    <div class="controls">
                        <select class="sort-select" id="phonetic-sort-select" onchange="sortPhoneticDerived()">
                            <option value="frequency">Sort: By Frequency</option>
                            <option value="grade">Sort: By Grade Level</option>
                            <option value="strokes">Sort: By Stroke Count</option>
                        </select>
                    </div>
                </div>
                <div class="character-grid" id="phonetic-derived-grid"></div>
            </div>
        </section>

        <!-- Radical Detail View -->
        <section id="radical-detail" class="radical-detail view">
            <div class="radical-hero" id="radical-hero">
                <!-- Populated by JS -->
            </div>
            <div class="character-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2>Derivative Characters (<span id="derivative-count">0</span>)</h2>
                    <div class="controls">
                        <select class="sort-select" id="sort-select" onchange="sortCharacters()">
                            <option value="default">Sort: Default (Grade ‚Üí Strokes)</option>
                            <option value="grade">Sort: By Grade Level</option>
                            <option value="strokes">Sort: By Stroke Count</option>
                            <option value="pinyin">Sort: By Pinyin</option>
                        </select>
                        <div class="filter-pills" id="grade-filters"></div>
                    </div>
                </div>
                <div class="character-grid" id="character-grid">
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>

        <!-- Character Detail View -->
        <section id="character-detail" class="character-detail view">
            <div class="character-hero" id="character-hero">
                <!-- Populated by JS -->
            </div>
            <div class="decomposition-box" id="decomposition-section" style="display: none;">
                <h3>Decomposition</h3>
                <div class="ids-visual" id="ids-visual"></div>
                <div class="components" id="components-list"></div>
            </div>
            <div class="words-section" id="words-section" style="display: none;">
                <h3>Example Words</h3>
                <div class="words-grid" id="words-grid"></div>
            </div>
            <div class="appears-in-section" id="appears-in-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
                    <h3 style="margin: 0;">Appears In (<span id="appears-in-count">0</span> characters)</h3>
                    <select class="sort-select" id="appears-in-sort" onchange="sortAppearsIn()" style="font-size: 0.8rem; padding: 0.3rem 0.5rem;">
                        <option value="frequency">Sort: Frequency</option>
                        <option value="grade">Sort: Grade</option>
                        <option value="strokes">Sort: Strokes</option>
                    </select>
                </div>
                <div class="derived-chars" id="derived-chars"></div>
            </div>
        </section>

        <!-- Word Detail View -->
        <section class="word-detail" id="word-detail">
            <div class="word-hero">
                <div class="word-chars" id="word-chars"></div>
                <div class="word-pinyin" id="word-pinyin"></div>
                <div class="word-definition" id="word-definition"></div>
                <span class="frequency-badge" id="word-frequency"></span>
            </div>
            <div class="character-breakdown">
                <h3>Character Breakdown</h3>
                <div class="breakdown-grid" id="breakdown-grid"></div>
            </div>
        </section>
    </main>

    <script>
        let data = null;
        let currentPhoneticChar = null;  // Track current phonetic for sorting
        let currentPhoneticDerived = []; // Store derived chars for re-sorting
        let currentAppearsIn = [];       // Store appears-in chars for sorting

        // Load data
        async function loadData() {
            try {
                const response = await fetch('data/radicals.json');
                data = await response.json();
                document.getElementById('char-count').textContent = 
                    Object.keys(data.characters).length.toLocaleString();
                renderRadicalGrid();
            } catch (error) {
                console.error('Failed to load data:', error);
                document.getElementById('radical-grid').innerHTML = 
                    '<p style="color: var(--accent);">Failed to load data. Make sure radicals.json exists.</p>';
            }
        }

        // Render radical grid
        function renderRadicalGrid(filter = '') {
            const grid = document.getElementById('radical-grid');
            const filterLower = filter.toLowerCase();
            
            let html = '';
            for (const [num, radical] of Object.entries(data.radicals)) {
                // Filter check
                if (filter) {
                    const matchMeaning = radical.meaning.toLowerCase().includes(filterLower);
                    const matchPinyin = radical.pinyin.toLowerCase().includes(filterLower);
                    const matchChar = radical.char.includes(filter);
                    if (!matchMeaning && !matchPinyin && !matchChar) continue;
                }

                html += `
                    <a href="#radical/${num}" class="radical-card" onclick="showRadical('${num}'); return false;">
                        <div class="radical-char">${radical.char}</div>
                        <div class="radical-pinyin">${radical.pinyin}</div>
                        <div class="radical-meaning">${radical.meaning}</div>
                        <div class="radical-count">${radical.characters.length} chars</div>
                    </a>
                `;
            }
            
            grid.innerHTML = html || '<p style="color: var(--text-muted);">No radicals match your search.</p>';
        }

        // Show radical detail
        let currentRadicalNum = null;

        function showRadical(num) {
            const radical = data.radicals[num];
            if (!radical) return;
            
            currentRadicalNum = num;

            // Update views
            document.getElementById('radical-list').style.display = 'none';
            document.getElementById('character-detail').classList.remove('active');
            document.getElementById('radical-detail').classList.add('active');

            // Update breadcrumb
            document.getElementById('breadcrumb').innerHTML = `
                <a href="#" onclick="showRadicalList(); return false;">All Radicals</a>
                <span class="separator">‚Ä∫</span>
                <span class="current">${radical.char} ${radical.pinyin}</span>
            `;

            // Render hero
            const gradedCount = radical.characters.filter(c => data.characters[c]?.gradeLevel > 0).length;
            document.getElementById('radical-hero').innerHTML = `
                <div class="char">${radical.char}</div>
                <div class="pinyin">${radical.pinyin}</div>
                <div class="meaning">${radical.meaning}</div>
                <div class="meta">Radical #${num} ‚Ä¢ ${radical.characters.length} characters (${gradedCount} graded)</div>
                <button class="ask-ai-btn" onclick="openChat('${radical.char}', {
                    pinyin: '${radical.pinyin}',
                    definition: 'Radical meaning: ${radical.meaning}',
                    radical: '${radical.char}',
                    strokes: ${radical.strokes || 0},
                    gradeLevel: 0,
                    components: [],
                    words: []
                })">
                    ü§ñ Ask AI
                </button>
            `;

            // Reset sort
            document.getElementById('sort-select').value = 'default';
            
            // Render characters
            renderCharacterGrid(radical.characters);

            // Update URL
            history.pushState(null, '', `#radical/${num}`);
        }

        function getGradeBadge(level) {
            if (level === 0) return '<span class="grade-badge grade-0">‚Äî</span>';
            return `<span class="grade-badge grade-${level}">G${level}</span>`;
        }
        
        // IDS operator definitions: how many arguments each takes
        const IDS_OPERATORS = {
            '‚ø∞': 2, '‚ø±': 2, '‚ø≤': 3, '‚ø≥': 3, '‚ø¥': 2, 
            '‚øµ': 2, '‚ø∂': 2, '‚ø∑': 2, '‚ø∏': 2, '‚øπ': 2, '‚ø∫': 2, '‚øª': 2
        };
        
        // Parse IDS string into a tree structure
        function parseIDSToTree(ids) {
            if (!ids) return null;
            let pos = 0;
            
            function parse() {
                if (pos >= ids.length) return null;
                const char = ids[pos];
                pos++;
                
                if (IDS_OPERATORS[char]) {
                    // This is an operator, parse its arguments
                    const argCount = IDS_OPERATORS[char];
                    const children = [];
                    for (let i = 0; i < argCount && pos < ids.length; i++) {
                        const child = parse();
                        if (child) children.push(child);
                    }
                    return { type: 'op', op: char, children };
                } else {
                    // This is a character (leaf node)
                    return { type: 'char', char };
                }
            }
            
            return parse();
        }
        
        // Render IDS tree as HTML with multiple levels
        function renderIDSHierarchy(tree, level = 0) {
            if (!tree) return '';
            
            if (tree.type === 'char') {
                // Leaf node - render as clickable component
                const compData = data.characters[tree.char];
                if (compData) {
                    return `<a href="#char/${encodeURIComponent(tree.char)}" class="component-tag"
                               onclick="showCharacter('${tree.char}'); return false;">
                                <span class="char">${tree.char}</span>
                                <span>${compData.pinyin || ''}</span>
                            </a>`;
                } else {
                    return `<a href="#phonetic/${encodeURIComponent(tree.char)}" class="component-tag"
                               onclick="showPhoneticDetail('${tree.char}'); return false;">
                                <span class="char">${tree.char}</span>
                            </a>`;
                }
            } else if (tree.type === 'op') {
                // Operator node - render children
                const childHtml = tree.children.map(c => renderIDSHierarchy(c, level + 1)).join('');
                return `<div class="ids-level" data-level="${level}">
                            <span class="ids-op">${tree.op}</span>
                            <div class="ids-children">${childHtml}</div>
                        </div>`;
            }
            return '';
        }
        
        // Flatten tree to just leaf components (for backward compatibility)
        function getTreeLeaves(tree) {
            if (!tree) return [];
            if (tree.type === 'char') return [tree.char];
            if (tree.type === 'op') {
                return tree.children.flatMap(c => getTreeLeaves(c));
            }
            return [];
        }

        function renderCharacterGrid(characters) {
            document.getElementById('derivative-count').textContent = characters.length;
            const charGrid = document.getElementById('character-grid');
            
            let html = '';
            for (const char of characters) {
                const charData = data.characters[char];
                if (!charData) continue;
                
                html += `
                    <a href="#char/${encodeURIComponent(char)}" class="character-card" 
                       onclick="showCharacter('${char}'); return false;">
                        <div class="char">${char}</div>
                        <div class="info">
                            <div class="pinyin">${charData.pinyin || '‚Äî'}</div>
                            <div class="definition">${charData.definition}</div>
                            <div class="meta">
                                ${getGradeBadge(charData.gradeLevel)}
                                <span class="strokes">${charData.strokes} strokes</span>
                            </div>
                        </div>
                    </a>
                `;
            }
            charGrid.innerHTML = html;
        }

        function sortCharacters() {
            if (!currentRadicalNum) return;
            
            const radical = data.radicals[currentRadicalNum];
            const sortBy = document.getElementById('sort-select').value;
            
            let sortedChars = [...radical.characters];
            
            switch (sortBy) {
                case 'grade':
                    // Graded first (1-6), then ungraded
                    sortedChars.sort((a, b) => {
                        const ga = data.characters[a]?.gradeLevel || 0;
                        const gb = data.characters[b]?.gradeLevel || 0;
                        if (ga === 0 && gb === 0) return 0;
                        if (ga === 0) return 1;
                        if (gb === 0) return -1;
                        return ga - gb;
                    });
                    break;
                case 'strokes':
                    sortedChars.sort((a, b) => {
                        const sa = data.characters[a]?.strokes || 0;
                        const sb = data.characters[b]?.strokes || 0;
                        return sa - sb;
                    });
                    break;
                case 'pinyin':
                    sortedChars.sort((a, b) => {
                        const pa = data.characters[a]?.pinyin || 'zzz';
                        const pb = data.characters[b]?.pinyin || 'zzz';
                        return pa.localeCompare(pb);
                    });
                    break;
                default:
                    // Default: already sorted by grade then strokes in JSON
                    break;
            }
            
            renderCharacterGrid(sortedChars);
        }

        // Show character detail
        function showCharacter(char) {
            const charData = data.characters[char];
            if (!charData) return;

            const radical = data.radicals[charData.radical];

            // Update views
            document.getElementById('radical-list').style.display = 'none';
            document.getElementById('learn-page').style.display = 'none';
            document.getElementById('phonetic-page').style.display = 'none';
            document.getElementById('phonetic-detail').classList.remove('active');
            document.getElementById('radical-detail').classList.remove('active');
            document.getElementById('character-detail').classList.add('active');

            // Update breadcrumb
            document.getElementById('breadcrumb').innerHTML = `
                <a href="#" onclick="showRadicalList(); return false;">All Radicals</a>
                <span class="separator">‚Ä∫</span>
                <a href="#radical/${charData.radical}" onclick="showRadical('${charData.radical}'); return false;">
                    ${radical.char} ${radical.pinyin}
                </a>
                <span class="separator">‚Ä∫</span>
                <span class="current">${char}</span>
            `;

            // Grade info
            const gradeText = charData.gradeLevel > 0 
                ? `Grade ${charData.gradeLevel}` 
                : 'Not in standard curriculum';

            // Render hero
            document.getElementById('character-hero').innerHTML = `
                <div class="char">${char}</div>
                <div class="pinyin">${charData.pinyin || 'No pinyin available'}</div>
                <div class="definition">${charData.definition}</div>
                <div style="margin-top: 1rem; display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                    ${getGradeBadge(charData.gradeLevel)}
                    <span style="color: var(--text-muted);">${charData.strokes} additional strokes</span>
                    ${charData.charFrequency ? `<span class="freq-badge">#${charData.charFrequency}</span>` : ''}
                </div>
                <a href="#radical/${charData.radical}" class="radical-link" 
                   onclick="showRadical('${charData.radical}'); return false;">
                    <span>Radical:</span>
                    <span class="radical-char">${radical.char}</span>
                    <span>${radical.meaning}</span>
                </a>
                ${charData.traditional ? `
                    <a href="#char/${encodeURIComponent(charData.traditional)}" class="variant-link"
                       onclick="showCharacter('${charData.traditional}'); return false;">
                        Traditional: <span class="variant-char">${charData.traditional}</span>
                    </a>
                ` : ''}
                ${charData.simplified ? `
                    <a href="#char/${encodeURIComponent(charData.simplified)}" class="variant-link"
                       onclick="showCharacter('${charData.simplified}'); return false;">
                        Simplified: <span class="variant-char">${charData.simplified}</span>
                    </a>
                ` : ''}
                <button class="ask-ai-btn" onclick="openChat('${char}', data.characters['${char}'])">
                    ü§ñ Ask AI
                </button>
            `;

            // Render decomposition section
            const decompSection = document.getElementById('decomposition-section');
            if (charData.ids && charData.ids !== char) {
                decompSection.style.display = 'block';
                
                // Parse IDS into tree and render hierarchically
                const idsTree = parseIDSToTree(charData.ids);
                if (idsTree) {
                    document.getElementById('ids-visual').innerHTML = renderIDSHierarchy(idsTree);
                } else {
                    // Fallback to plain text
                    document.getElementById('ids-visual').textContent = charData.ids;
                }
                
                // Render flat component list below (for quick reference)
                const leaves = charData.components || [];
                let componentsHtml = '';
                for (const comp of leaves) {
                    const compData = data.characters[comp];
                    if (compData) {
                        componentsHtml += `
                            <a href="#char/${encodeURIComponent(comp)}" class="component-tag"
                               onclick="showCharacter('${comp}'); return false;">
                                <span class="char">${comp}</span>
                                <span>${compData.pinyin || ''}</span>
                            </a>
                        `;
                    } else {
                        componentsHtml += `
                            <a href="#phonetic/${encodeURIComponent(comp)}" class="component-tag"
                               onclick="showPhoneticDetail('${comp}'); return false;">
                                <span class="char">${comp}</span>
                            </a>
                        `;
                    }
                }
                document.getElementById('components-list').innerHTML = componentsHtml || '<span style="color: var(--text-muted);">No component data</span>';
            } else {
                decompSection.style.display = 'none';
            }

            // Render example words section
            const wordsSection = document.getElementById('words-section');
            if (charData.words && charData.words.length > 0) {
                wordsSection.style.display = 'block';
                let wordsHtml = '';
                for (const word of charData.words.slice(0, 15)) {
                    const wordData = data.words?.[word];
                    if (wordData) {
                        // Escape quotes in definition for safety
                        const safeDefinition = wordData.definition.replace(/"/g, '&quot;');
                        wordsHtml += `
                            <a href="#word/${encodeURIComponent(word)}" class="word-tag"
                               onclick="showWord('${word.replace(/'/g, "\\'")}'); return false;">
                                <div class="word-header">
                                    <span class="word-chars">${word}</span>
                                    <span class="pinyin">${wordData.pinyin}</span>
                                </div>
                                <div class="definition">${wordData.definition}</div>
                            </a>
                        `;
                    } else {
                        wordsHtml += `<div class="word-tag"><span class="word-chars">${word}</span></div>`;
                    }
                }
                document.getElementById('words-grid').innerHTML = wordsHtml;
            } else {
                wordsSection.style.display = 'none';
            }

            // Render appears-in section
            const appearsSection = document.getElementById('appears-in-section');
            if (charData.appearsIn && charData.appearsIn.length > 0) {
                appearsSection.style.display = 'block';
                currentAppearsIn = charData.appearsIn.filter(c => data.characters[c]);
                document.getElementById('appears-in-sort').value = 'frequency';
                renderAppearsIn();
            } else {
                appearsSection.style.display = 'none';
                currentAppearsIn = [];
            }

            // Update URL
            history.pushState(null, '', `#char/${encodeURIComponent(char)}`);
        }
        
        function renderAppearsIn() {
            const sortBy = document.getElementById('appears-in-sort').value;
            
            // Sort the characters
            let sorted = [...currentAppearsIn];
            sorted.sort((a, b) => {
                const aData = data.characters[a];
                const bData = data.characters[b];
                
                if (sortBy === 'frequency') {
                    const aFreq = aData.charFrequency || 999999;
                    const bFreq = bData.charFrequency || 999999;
                    return aFreq - bFreq;
                } else if (sortBy === 'grade') {
                    const aGrade = aData.gradeLevel || 99;
                    const bGrade = bData.gradeLevel || 99;
                    return aGrade - bGrade;
                } else { // strokes
                    return (aData.strokes || 99) - (bData.strokes || 99);
                }
            });
            
            document.getElementById('appears-in-count').textContent = sorted.length;
            
            let html = '';
            for (const derivedChar of sorted) {
                const dcData = data.characters[derivedChar];
                html += `
                    <a href="#char/${encodeURIComponent(derivedChar)}" class="character-card"
                       onclick="showCharacter('${derivedChar}'); return false;">
                        <div class="char">${derivedChar}</div>
                        <div class="info">
                            <div class="pinyin">${dcData.pinyin || ''}</div>
                            <div class="definition">${(dcData.definition || '').substring(0, 50)}</div>
                            <div class="meta">
                                ${getGradeBadge(dcData.gradeLevel)}
                            </div>
                        </div>
                    </a>
                `;
            }
            document.getElementById('derived-chars').innerHTML = html;
        }
        
        function sortAppearsIn() {
            renderAppearsIn();
        }

        // Show radical list
        function showRadicalList() {
            document.getElementById('radical-list').style.display = 'block';
            document.getElementById('learn-page').style.display = 'none';
            document.getElementById('radical-detail').classList.remove('active');
            document.getElementById('character-detail').classList.remove('active');
            document.getElementById('word-detail').classList.remove('active');
            
            // Update tabs
            document.getElementById('tab-radicals').classList.add('active');
            document.getElementById('tab-learn').classList.remove('active');

            document.getElementById('breadcrumb').innerHTML = `
                <a href="#" onclick="showRadicalList(); return false;">All Radicals</a>
            `;

            history.pushState(null, '', '#');
        }

        // Show learn page
        let learnPage = 0;
        const learnPageSize = 50;
        
        function showLearnPage() {
            document.getElementById('radical-list').style.display = 'none';
            document.getElementById('learn-page').style.display = 'block';
            document.getElementById('radical-detail').classList.remove('active');
            document.getElementById('character-detail').classList.remove('active');
            document.getElementById('word-detail').classList.remove('active');
            
            // Update tabs
            document.getElementById('tab-radicals').classList.remove('active');
            document.getElementById('tab-learn').classList.add('active');
            
            document.getElementById('breadcrumb').innerHTML = `
                <a href="#learn" onclick="showLearnPage(); return false;">Learn</a>
            `;
            
            learnPage = 0;
            renderLearnGrid();
            history.pushState(null, '', '#learn');
        }

        let phoneticPage = 0;
        const phoneticPageSize = 50;

        function showPhoneticPage() {
            document.getElementById('radical-list').style.display = 'none';
            document.getElementById('learn-page').style.display = 'none';
            document.getElementById('phonetic-page').style.display = 'block';
            document.getElementById('phonetic-detail').classList.remove('active');
            document.getElementById('radical-detail').classList.remove('active');
            document.getElementById('character-detail').classList.remove('active');
            document.getElementById('word-detail').classList.remove('active');
            
            // Update tabs
            document.getElementById('tab-radicals').classList.remove('active');
            document.getElementById('tab-learn').classList.remove('active');
            document.getElementById('tab-phonetic').classList.add('active');
            
            document.getElementById('breadcrumb').innerHTML = `
                <a href="#phonetic" onclick="showPhoneticPage(); return false;">Common Components</a>
            `;
            
            phoneticPage = 0;
            renderPhoneticGrid();
            history.pushState(null, '', '#phonetic');
        }

        function renderPhoneticGrid() {
            const minDerived = parseInt(document.getElementById('phonetic-min-derived').value);
            const sortBy = document.getElementById('phonetic-sort').value;
            
            // Get all characters with appearsIn (potential phonetic components)
            let phonetics = Object.entries(data.characters)
                .filter(([char, d]) => d.appearsIn && d.appearsIn.length >= minDerived)
                .map(([char, d]) => ({
                    char,
                    pinyin: d.pinyin,
                    definition: d.definition,
                    count: d.appearsIn.length,
                    frequency: d.charFrequency || 999999
                }));
            
            // Sort
            if (sortBy === 'count') {
                phonetics.sort((a, b) => b.count - a.count);
            } else {
                phonetics.sort((a, b) => a.frequency - b.frequency);
            }
            
            // Paginate
            const totalPhonetics = phonetics.length;
            const totalPages = Math.ceil(totalPhonetics / phoneticPageSize);
            const startIdx = phoneticPage * phoneticPageSize;
            const pagePhonetics = phonetics.slice(startIdx, startIdx + phoneticPageSize);
            
            // Update count
            document.getElementById('phonetic-count').textContent = 
                `Showing ${startIdx + 1}-${Math.min(startIdx + phoneticPageSize, totalPhonetics)} of ${totalPhonetics}`;
            
            // Render grid
            let html = '';
            for (const p of pagePhonetics) {
                html += `
                    <a href="#phonetic/${encodeURIComponent(p.char)}" class="character-card"
                       onclick="showPhoneticDetail('${p.char}'); return false;">
                        <div class="char">${p.char}</div>
                        <div class="pinyin">${p.pinyin || ''}</div>
                        <div class="definition">${(p.definition || '').substring(0, 30)}</div>
                        <div class="meta">
                            <span class="freq-badge">${p.count} derived</span>
                        </div>
                    </a>
                `;
            }
            document.getElementById('phonetic-grid').innerHTML = html;
            
            // Render pagination
            let paginationHtml = '';
            if (totalPages > 1) {
                if (phoneticPage > 0) {
                    paginationHtml += `<button onclick="phoneticPage--; renderPhoneticGrid();">‚Üê Prev</button>`;
                }
                paginationHtml += `<span>Page ${phoneticPage + 1} of ${totalPages}</span>`;
                if (phoneticPage < totalPages - 1) {
                    paginationHtml += `<button onclick="phoneticPage++; renderPhoneticGrid();">Next ‚Üí</button>`;
                }
            }
            document.getElementById('phonetic-pagination').innerHTML = paginationHtml;
        }

        function showPhoneticDetail(char) {
            const charData = data.characters[char];
            
            // Get derived characters - either from appearsIn or by searching components
            let derivedChars = [];
            let pinyin = '';
            let definition = '';
            
            if (charData) {
                derivedChars = charData.appearsIn || [];
                pinyin = charData.pinyin || '';
                definition = charData.definition || '';
            } else {
                // Component not in characters dict - search for chars containing it
                for (const [c, cData] of Object.entries(data.characters)) {
                    if (cData.components && cData.components.includes(char)) {
                        derivedChars.push(c);
                    }
                }
            }
            
            // If no derived chars found, just show empty state
            if (derivedChars.length === 0 && !charData) {
                derivedChars = [];
            }

            // Update views
            document.getElementById('radical-list').style.display = 'none';
            document.getElementById('learn-page').style.display = 'none';
            document.getElementById('phonetic-page').style.display = 'none';
            document.getElementById('phonetic-detail').classList.add('active');
            document.getElementById('radical-detail').classList.remove('active');
            document.getElementById('character-detail').classList.remove('active');

            // Update tabs
            document.getElementById('tab-radicals').classList.remove('active');
            document.getElementById('tab-learn').classList.remove('active');
            document.getElementById('tab-phonetic').classList.add('active');

            // Update breadcrumb
            document.getElementById('breadcrumb').innerHTML = `
                <a href="#phonetic" onclick="showPhoneticPage(); return false;">Common Components</a>
                <span class="separator">‚Ä∫</span>
                <span class="current">${char}</span>
            `;

            // Render hero
            document.getElementById('phonetic-hero').innerHTML = `
                <div class="char">${char}</div>
                <div class="pinyin">${pinyin}</div>
                <div class="meaning">${definition}</div>
                <div class="meta">${derivedChars.length} derived characters</div>
            `;

            // Store for sorting
            currentPhoneticChar = char;
            currentPhoneticDerived = derivedChars.filter(dc => data.characters[dc]);
            
            // Reset sort to frequency and render
            document.getElementById('phonetic-sort-select').value = 'frequency';
            renderPhoneticDerivedGrid();

            // Update URL
            history.pushState(null, '', `#phonetic/${encodeURIComponent(char)}`);
        }
        
        function renderPhoneticDerivedGrid() {
            const sortBy = document.getElementById('phonetic-sort-select').value;
            
            // Sort derived characters
            let sorted = [...currentPhoneticDerived];
            sorted.sort((a, b) => {
                const aData = data.characters[a];
                const bData = data.characters[b];
                
                if (sortBy === 'frequency') {
                    // Higher frequency first (lower rank number = higher frequency)
                    const aFreq = aData.charFrequency || 999999;
                    const bFreq = bData.charFrequency || 999999;
                    return aFreq - bFreq;
                } else if (sortBy === 'grade') {
                    // Lower grade first, 0 = ungraded goes last
                    const aGrade = aData.gradeLevel || 99;
                    const bGrade = bData.gradeLevel || 99;
                    return aGrade - bGrade;
                } else { // strokes
                    return (aData.strokes || 99) - (bData.strokes || 99);
                }
            });
            
            document.getElementById('phonetic-derived-count').textContent = sorted.length;

            let html = '';
            for (const dc of sorted) {
                const dcData = data.characters[dc];
                html += `
                    <a href="#char/${encodeURIComponent(dc)}" class="character-card"
                       onclick="showCharacter('${dc}'); return false;">
                        <div class="char">${dc}</div>
                        <div class="pinyin">${dcData.pinyin || ''}</div>
                        <div class="definition">${(dcData.definition || '').substring(0, 40)}</div>
                        <div class="meta">
                            ${getGradeBadge(dcData.gradeLevel)}
                        </div>
                    </a>
                `;
            }
            document.getElementById('phonetic-derived-grid').innerHTML = html;
        }
        
        function sortPhoneticDerived() {
            renderPhoneticDerivedGrid();
        }


        function renderLearnGrid() {
            const gradeFilter = document.getElementById('learn-grade-filter').value;
            const sortBy = document.getElementById('learn-sort').value;
            const script = document.getElementById('learn-script').value;
            
            // Get all characters
            let chars = Object.entries(data.characters).map(([char, d]) => ({char, ...d}));
            
            // Filter by script type (deduplicate simplified/traditional)
            if (script === 'simplified') {
                // Show chars that ARE simplified (have traditional variant) or have no variant
                // Hide chars that ARE traditional (have simplified variant)
                chars = chars.filter(c => !c.simplified);
            } else {
                // Show chars that ARE traditional (have simplified variant) or have no variant
                // Hide chars that ARE simplified (have traditional variant)
                chars = chars.filter(c => !c.traditional);
            }
            
            // Filter by grade
            if (gradeFilter !== 'all') {
                const grade = parseInt(gradeFilter);
                chars = chars.filter(c => c.gradeLevel === grade);
            }
            
            // Sort
            switch (sortBy) {
                case 'frequency':
                    chars.sort((a, b) => {
                        const freqA = a.charFrequency || 999999;
                        const freqB = b.charFrequency || 999999;
                        return freqA - freqB;
                    });
                    break;
                case 'strokes':
                    chars.sort((a, b) => a.strokes - b.strokes);
                    break;
                case 'grade':
                    chars.sort((a, b) => {
                        const ga = a.gradeLevel || 99;
                        const gb = b.gradeLevel || 99;
                        return ga - gb || a.strokes - b.strokes;
                    });
                    break;
            }
            
            // Paginate
            const totalChars = chars.length;
            const totalPages = Math.ceil(totalChars / learnPageSize);
            const startIdx = learnPage * learnPageSize;
            const pageChars = chars.slice(startIdx, startIdx + learnPageSize);
            
            // Update count
            document.getElementById('learn-count').textContent = 
                `Showing ${startIdx + 1}-${Math.min(startIdx + learnPageSize, totalChars)} of ${totalChars.toLocaleString()}`;
            
            // Render grid
            let html = '';
            for (const c of pageChars) {
                html += `
                    <a href="#char/${encodeURIComponent(c.char)}" class="character-card"
                       onclick="showCharacter('${c.char}'); return false;">
                        <div class="char">${c.char}</div>
                        <div class="info">
                            <div class="pinyin">${c.pinyin || '‚Äî'}</div>
                            <div class="definition">${c.definition}</div>
                            <div class="meta">
                                ${getGradeBadge(c.gradeLevel)}
                                ${c.charFrequency ? `<span class="freq-badge">#${c.charFrequency}</span>` : ''}
                            </div>
                        </div>
                    </a>
                `;
            }
            document.getElementById('learn-grid').innerHTML = html;
            
            // Render pagination
            let paginationHtml = '';
            paginationHtml += `<button onclick="learnPage = 0; renderLearnGrid()" ${learnPage === 0 ? 'disabled' : ''}>¬´</button>`;
            paginationHtml += `<button onclick="learnPage = Math.max(0, learnPage - 1); renderLearnGrid()" ${learnPage === 0 ? 'disabled' : ''}>‚Äπ</button>`;
            
            // Page numbers
            const maxButtons = 5;
            let startPage = Math.max(0, learnPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons);
            if (endPage - startPage < maxButtons) startPage = Math.max(0, endPage - maxButtons);
            
            for (let i = startPage; i < endPage; i++) {
                paginationHtml += `<button onclick="learnPage = ${i}; renderLearnGrid()" class="${i === learnPage ? 'active' : ''}">${i + 1}</button>`;
            }
            
            paginationHtml += `<button onclick="learnPage = Math.min(${totalPages - 1}, learnPage + 1); renderLearnGrid()" ${learnPage >= totalPages - 1 ? 'disabled' : ''}>‚Ä∫</button>`;
            paginationHtml += `<button onclick="learnPage = ${totalPages - 1}; renderLearnGrid()" ${learnPage >= totalPages - 1 ? 'disabled' : ''}>¬ª</button>`;
            
            document.getElementById('learn-pagination').innerHTML = paginationHtml;
        }

        // Handle URL routing
        function handleRoute() {
            const hash = window.location.hash;
            
            if (hash.startsWith('#radical/')) {
                const num = hash.replace('#radical/', '');
                if (data) showRadical(num);
            } else if (hash.startsWith('#char/')) {
                const char = decodeURIComponent(hash.replace('#char/', ''));
                if (data) showCharacter(char);
            } else if (hash.startsWith('#word/')) {
                const word = decodeURIComponent(hash.replace('#word/', ''));
                if (data) showWord(word);
            } else if (hash === '#learn') {
                if (data) showLearnPage();
            } else if (hash.startsWith('#phonetic/')) {
                const char = decodeURIComponent(hash.replace('#phonetic/', ''));
                if (data) showPhoneticDetail(char);
            } else if (hash === '#phonetic') {
                if (data) showPhoneticPage();
            } else {
                showRadicalList();
            }
        }

        // Show word detail
        function showWord(word) {
            const wordData = data.words?.[word];
            if (!wordData) {
                showRadicalList();
                return;
            }

            document.getElementById('radical-list').style.display = 'none';
            document.getElementById('radical-detail').classList.remove('active');
            document.getElementById('character-detail').classList.remove('active');
            document.getElementById('word-detail').classList.add('active');

            // Breadcrumb
            document.getElementById('breadcrumb').innerHTML = `
                <a href="#" onclick="showRadicalList(); return false;">All Radicals</a>
                <span class="sep">‚Ä∫</span>
                <span>${word}</span>
            `;

            // Word info
            document.getElementById('word-chars').textContent = word;
            document.getElementById('word-pinyin').textContent = wordData.pinyin;
            document.getElementById('word-definition').textContent = wordData.definition;

            // Frequency badge
            const freq = wordData.frequency || 0;
            const freqBadge = document.getElementById('word-frequency');
            if (freq > 0 && freq <= 1000) {
                freqBadge.textContent = `Top ${freq.toLocaleString()} most common`;
                freqBadge.className = 'frequency-badge common';
            } else if (freq > 0) {
                freqBadge.textContent = `Frequency rank: ${freq.toLocaleString()}`;
                freqBadge.className = 'frequency-badge';
            } else {
                freqBadge.textContent = '';
                freqBadge.style.display = 'none';
            }

            // Character breakdown
            let breakdownHtml = '';
            for (const char of word) {
                const charData = data.characters[char];
                if (charData) {
                    breakdownHtml += `
                        <a href="#char/${encodeURIComponent(char)}" class="breakdown-card"
                           onclick="showCharacter('${char}'); return false;">
                            <span class="breakdown-char">${char}</span>
                            <div class="breakdown-info">
                                <div class="breakdown-pinyin">${charData.pinyin}</div>
                                <div class="breakdown-meaning">${charData.definition?.slice(0, 50) || ''}${charData.definition?.length > 50 ? '...' : ''}</div>
                            </div>
                        </a>
                    `;
                } else {
                    breakdownHtml += `
                        <div class="breakdown-card">
                            <span class="breakdown-char">${char}</span>
                            <div class="breakdown-info">
                                <div class="breakdown-meaning">Character not in database</div>
                            </div>
                        </div>
                    `;
                }
            }
            document.getElementById('breakdown-grid').innerHTML = breakdownHtml;

            // Update URL
            history.pushState(null, '', `#word/${encodeURIComponent(word)}`);
        }

        // Search functionality
        document.getElementById('radical-search').addEventListener('input', (e) => {
            renderRadicalGrid(e.target.value);
        });

        // Init
        window.addEventListener('hashchange', handleRoute);
        loadData().then(handleRoute);
        
        // ============ LLM Chat Integration ============
        
        let chatContext = null;
        let chatMessages = [];
        let isStreaming = false;
        
        const OPENROUTER_API_URL = 'https://openrouter.ai/api/v1/chat/completions';
        const MODEL = 'google/gemini-3-flash-preview';
        
        const SYSTEM_PROMPT = `You are a Chinese language tutor specializing in character etymology and composition.

Given character data, provide helpful explanations about:
- Etymology and historical evolution of the character
- The meaning and role of each component (semantic vs phonetic)
- Mnemonics to help remember the character
- Example words and usage contexts

Be concise but informative. Use simple language suitable for learners.
Format responses with clear sections when appropriate.`;

        function getApiKey() {
            return localStorage.getItem('openrouter_api_key') || '';
        }
        
        function setApiKey(key) {
            localStorage.setItem('openrouter_api_key', key);
        }
        
        function openSettings() {
            document.getElementById('settings-modal').classList.add('active');
            document.getElementById('api-key-input').value = getApiKey();
        }
        
        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }
        
        function saveSettings() {
            const key = document.getElementById('api-key-input').value.trim();
            setApiKey(key);
            closeSettings();
        }
        
        function openChat(char, charData) {
            chatContext = { char, ...charData };
            chatMessages = [];
            
            document.getElementById('chat-title').textContent = `Ask about ${char}`;
            document.getElementById('chat-messages').innerHTML = `
                <div class="chat-message assistant">
                    üëã Ask me anything about <strong>${char}</strong> (${charData.pinyin || ''})!
                    <br><br>
                    I can explain its etymology, components, usage, and give you mnemonics to remember it.
                </div>
            `;
            document.getElementById('chat-panel').classList.add('active');
            document.getElementById('chat-input').focus();
        }
        
        function closeChat() {
            document.getElementById('chat-panel').classList.remove('active');
        }
        
        function sendQuickPrompt(prompt) {
            document.getElementById('chat-input').value = prompt;
            sendMessage();
        }
        
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const userMessage = input.value.trim();
            if (!userMessage || isStreaming) return;
            
            const apiKey = getApiKey();
            if (!apiKey) {
                alert('Please set your OpenRouter API key in Settings first.');
                openSettings();
                return;
            }
            
            // Add user message to UI
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.innerHTML += `<div class="chat-message user">${escapeHtml(userMessage)}</div>`;
            input.value = '';
            
            // Add to history
            chatMessages.push({ role: 'user', content: userMessage });
            
            // Create assistant message placeholder
            const assistantDiv = document.createElement('div');
            assistantDiv.className = 'chat-message assistant';
            assistantDiv.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            messagesDiv.appendChild(assistantDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            isStreaming = true;
            document.getElementById('chat-send').disabled = true;
            
            try {
                // Build context message
                const contextMsg = `Character: ${chatContext.char}
Pinyin: ${chatContext.pinyin || 'Unknown'}
Definition: ${chatContext.definition || 'Unknown'}
Radical: ${chatContext.radical || 'Unknown'}
Stroke count: ${chatContext.strokes || 'Unknown'}
Grade level: ${chatContext.gradeLevel || 'Unknown'}
IDS decomposition: ${chatContext.ids || 'None'}
Components: ${(chatContext.components || []).join(', ') || 'None'}
Traditional form: ${chatContext.traditional || 'Same'}
Simplified form: ${chatContext.simplified || 'Same'}
Example words: ${(chatContext.words || []).slice(0, 5).join(', ') || 'None'}`;

                const messages = [
                    { role: 'system', content: SYSTEM_PROMPT + '\n\n' + contextMsg },
                    ...chatMessages
                ];
                
                const response = await fetch(OPENROUTER_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Chinese Radicals Learning App'
                    },
                    body: JSON.stringify({
                        model: MODEL,
                        messages: messages,
                        stream: true
                    })
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`API error: ${response.status} - ${error}`);
                }
                
                // Stream the response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                assistantDiv.innerHTML = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const json = JSON.parse(data);
                                const content = json.choices?.[0]?.delta?.content;
                                if (content) {
                                    fullResponse += content;
                                    assistantDiv.innerHTML = formatMarkdown(fullResponse);
                                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                                }
                            } catch (e) {
                                // Skip invalid JSON chunks
                            }
                        }
                    }
                }
                
                // Save assistant response to history
                chatMessages.push({ role: 'assistant', content: fullResponse });
                
            } catch (error) {
                console.error('Chat error:', error);
                assistantDiv.innerHTML = `<span style="color: var(--accent);">Error: ${error.message}</span>`;
            } finally {
                isStreaming = false;
                document.getElementById('chat-send').disabled = false;
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatMarkdown(text) {
            // Enhanced markdown formatting
            let html = text
                // Escape HTML first
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                // Headers (must come before other processing)
                .replace(/^### (.+)$/gm, '<h4>$1</h4>')
                .replace(/^## (.+)$/gm, '<h3>$1</h3>')
                .replace(/^# (.+)$/gm, '<h2>$1</h2>')
                // Bold and italic
                .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Unordered lists
                .replace(/^[-‚Ä¢] (.+)$/gm, '<li>$1</li>')
                // Numbered lists
                .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
                // Wrap consecutive <li> in <ul>
                .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
                // Paragraphs (double newlines)
                .replace(/\n\n+/g, '</p><p>')
                // Single line breaks
                .replace(/\n/g, '<br>');
            
            // Wrap in paragraph tags
            html = '<p>' + html + '</p>';
            
            // Clean up empty paragraphs and fix ul/p nesting
            html = html
                .replace(/<p>\s*<\/p>/g, '')
                .replace(/<p>(<ul>)/g, '$1')
                .replace(/(<\/ul>)<\/p>/g, '$1')
                .replace(/<p>(<h[234]>)/g, '$1')
                .replace(/(<\/h[234]>)<\/p>/g, '$1');
            
            // Auto-link Chinese characters and words
            // Match sequences of CJK characters (excluding those already in links)
            html = html.replace(/([\u4e00-\u9fff]+)/g, function(match) {
                const encoded = encodeURIComponent(match);
                // Single character -> #char/, multiple characters -> #word/
                const prefix = match.length === 1 ? 'char' : 'word';
                return `<a href="#${prefix}/${encoded}" class="chinese-link" onclick="event.stopPropagation()">${match}</a>`;
            });
            
            return html;
        }
        
        // Handle Enter key in chat input
        document.addEventListener('keydown', function(e) {
            if (e.target.id === 'chat-input' && e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Chat panel resize functionality
        document.addEventListener('DOMContentLoaded', function() {
            const chatPanel = document.getElementById('chat-panel');
            const resizeHandle = document.getElementById('chat-resize-handle');
            if (!chatPanel || !resizeHandle) return;
            
            let isResizing = false;
            let startX, startWidth;
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startWidth = chatPanel.offsetWidth;
                chatPanel.classList.add('resizing');
                resizeHandle.classList.add('active');
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const deltaX = startX - e.clientX;
                const newWidth = Math.min(Math.max(startWidth + deltaX, 320), window.innerWidth * 0.8);
                chatPanel.style.width = newWidth + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    chatPanel.classList.remove('resizing');
                    resizeHandle.classList.remove('active');
                    // Save width to localStorage
                    localStorage.setItem('chat_panel_width', chatPanel.style.width);
                }
            });
            
            // Restore saved width
            const savedWidth = localStorage.getItem('chat_panel_width');
            if (savedWidth) {
                chatPanel.style.width = savedWidth;
            }
        });
    </script>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal" onclick="if(event.target === this) closeSettings()">
        <div class="modal">
            <h2>‚öôÔ∏è Settings</h2>
            <label for="api-key-input">OpenRouter API Key</label>
            <input type="password" id="api-key-input" placeholder="sk-or-v1-...">
            <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 1rem;">
                Get your API key from <a href="https://openrouter.ai/keys" target="_blank" style="color: var(--accent);">openrouter.ai/keys</a>
            </p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Chat Panel -->
    <div class="chat-panel" id="chat-panel">
        <div class="chat-resize-handle" id="chat-resize-handle"></div>
        <div class="chat-header">
            <h3>ü§ñ <span id="chat-title">Ask about Â≠ó</span></h3>
            <button class="chat-close" onclick="closeChat()">‚úï</button>
        </div>
        <div class="chat-prompts">
            <button class="quick-prompt" onclick="sendQuickPrompt('Explain the etymology')">Etymology</button>
            <button class="quick-prompt" onclick="sendQuickPrompt('How do the components work?')">Components</button>
            <button class="quick-prompt" onclick="sendQuickPrompt('Give me a mnemonic')">Mnemonic</button>
            <button class="quick-prompt" onclick="sendQuickPrompt('Common words and usage')">Usage</button>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-area">
            <textarea class="chat-input" id="chat-input" rows="1" placeholder="Ask a question..."></textarea>
            <button class="chat-send" id="chat-send" onclick="sendMessage()">‚ñ∂</button>
        </div>
    </div>
</body>
</html>
